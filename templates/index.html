<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Pantry - Ø¨ÙŠØªÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color:#6c5ce7; --success-color:#00b894; --warning-color:#fdcb6e; --danger-color:#d63031; --bg-color:#f5f6fa; }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Tajawal',sans-serif;background-color:var(--bg-color);padding-bottom:80px;overflow-x:hidden}
        .app-header{background:linear-gradient(135deg,var(--primary-color) 0%,#a29bfe 100%);color:#fff;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
        .app-header h4{margin:0;font-weight:700;display:flex;align-items:center;gap:10px}
        .item-card{background:#fff;border-radius:15px;padding:15px;margin-bottom:15px;box-shadow:0 4px 6px rgba(0,0,0,.05);border:none;position:relative;overflow:hidden;transition:all .3s ease}
        .item-card:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.1)}
        .status-strip{position:absolute;top:0;bottom:0;right:0;width:6px}
        body.lang-en .status-strip{right:auto;left:0}
        .bg-good{background-color:var(--success-color)}.bg-warning{background-color:var(--warning-color)}.bg-expired{background-color:var(--danger-color)}
        .btn-circle{width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid;transition:all .3s}
        .btn-circle:hover{transform:scale(1.1)}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;height:70px;display:flex;justify-content:space-around;align-items:center;box-shadow:0 -2px 10px rgba(0,0,0,.1);z-index:1000;border-top-left-radius:20px;border-top-right-radius:20px}
        .nav-item{text-align:center;color:#b2bec3;font-size:.8rem;cursor:pointer;transition:all .3s;padding:5px 10px;border-radius:10px}
        .nav-item.active{color:var(--primary-color);font-weight:bold;background:rgba(108,92,231,.1)}
        .nav-item i{font-size:1.5rem;display:block;margin-bottom:2px}
        .fab-btn{position:absolute;top:-25px;left:50%;transform:translateX(-50%);width:60px;height:60px;background:var(--primary-color);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(108,92,231,.4);font-size:1.8rem;border:none;transition:all .3s}
        .fab-btn:hover{transform:translateX(-50%) scale(1.1);box-shadow:0 6px 20px rgba(108,92,231,.6)}
        .flash-messages{position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:9999;width:90%;max-width:500px}
        .flash-alert{animation:slideDown .5s ease-out;margin-bottom:10px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
        @keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        body.lang-en{direction:ltr;font-family:'Segoe UI',sans-serif}
        body.lang-ar{direction:rtl}
        .show-ar{display:inline}.show-en{display:none}
        body.lang-en .show-ar{display:none}body.lang-en .show-en{display:inline}
        .page-section{display:none;animation:fadeIn .3s}
        .page-section.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .empty-state{text-align:center;padding:60px 20px;color:#999}
        .empty-state i{font-size:64px;color:#ddd;margin-bottom:20px}
        .modal-content{border-radius:20px;border:none}
        .modal-header{background:linear-gradient(135deg,var(--primary-color) 0%,#a29bfe 100%);color:#fff;border-radius:20px 20px 0 0}
        .form-control:focus{border-color:var(--primary-color);box-shadow:0 0 0 .2rem rgba(108,92,231,.25)}
        .stats-badge{display:inline-block;background:rgba(255,255,255,.2);padding:5px 15px;border-radius:20px;font-size:.85rem;margin-left:10px}
        @media (max-width:480px){.item-card{padding:12px}.btn-circle{width:30px;height:30px}.app-header h4{font-size:1.1rem}}
    </style>
</head>
<body class="lang-ar">
    <div class="app-header d-flex justify-content-between align-items-center">
        <h4>
            <span class="show-ar">ğŸ  Ø¨ÙŠØªÙŠ Ø§Ù„Ø°ÙƒÙŠ</span>
            <span class="show-en">ğŸ  Smart Home</span>
            <span class="stats-badge">{{ inventory|length }}</span>
        </h4>
        <div class="d-flex gap-2">
            <a href="/page2" class="btn btn-sm btn-light rounded-pill px-3">
                Ø§Ø°Ù‡Ø¨ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© â¡ï¸
            </a>
            <button class="btn btn-sm btn-light rounded-pill px-3" onclick="toggleLang()">
                <span class="show-ar">English</span>
                <span class="show-en">Ø¹Ø±Ø¨ÙŠ</span>
            </button>
        </div>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
        {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show flash-alert" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    <div class="container mt-3">
        <div id="tab-inventory" class="page-section active">
            <h6 class="text-muted mb-3 fw-bold">
                <i class="bi bi-box-seam me-2"></i>
                <span class="show-ar">ÙƒÙ„ Ø§Ù„Ø£ØºØ±Ø§Ø¶ ({{ inventory|length }})</span>
                <span class="show-en">All Items ({{ inventory|length }})</span>
            </h6>
            {% if inventory %}
            {% for item in inventory %}
            <div class="item-card">
                <div class="status-strip bg-{{ item.status }}"></div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="px-2 flex-grow-1">
                        <h5 class="mb-1 fw-bold">
                            <span class="show-ar">{{ item.name_ar }}</span>
                            <span class="show-en">{{ item.name_en }}</span>
                        </h5>
                        <small class="text-muted d-block" style="font-size:.75rem;">
                            <i class="bi bi-calendar3"></i>
                            <span class="show-ar">ÙŠÙ†ØªÙ‡ÙŠ: {{ item.expiry or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                            <span class="show-en">Exp: {{ item.expiry or 'N/A' }}</span>
                        </small>
                        {% if item.status == 'expired' %}
                        <span class="badge bg-danger mt-1"><span class="show-ar">âŒ Ù…Ù†ØªÙ‡ÙŠ</span><span class="show-en">âŒ Expired</span></span>
                        {% elif item.status == 'warning' %}
                        <span class="badge bg-warning text-dark mt-1"><span class="show-ar">âš ï¸ Ù‚Ø±ÙŠØ¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span><span class="show-en">âš ï¸ Expiring Soon</span></span>
                        {% endif %}
                        {% if item.need_buy %}
                        <span class="badge bg-info text-dark mt-1"><span class="show-ar">ğŸ›’ ÙŠØ­ØªØ§Ø¬ Ø´Ø±Ø§Ø¡</span><span class="show-en">ğŸ›’ Need to Buy</span></span>
                        {% endif %}
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <a href="/update/{{ item.id }}/dec" class="btn btn-outline-danger btn-circle"><i class="bi bi-dash"></i></a>
                        <span class="fw-bold fs-5 mx-2">{{ item.qty }}</span>
                        <a href="/update/{{ item.id }}/inc" class="btn btn-outline-success btn-circle"><i class="bi bi-plus-lg"></i></a>
                    </div>
                </div>
                <a href="/delete/{{ item.id }}" class="position-absolute text-danger" style="top:10px; left:10px; font-size:1.2rem;" onclick="return confirm('{{ 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ' if request.cookies.get('lang') != 'en' else 'Delete this item?' }}')"><i class="bi bi-trash"></i></a>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <h5 class="mt-3"><span class="show-ar">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØºØ±Ø§Ø¶</span><span class="show-en">No items yet</span></h5>
                <p class="text-muted"><span class="show-ar">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ ØµÙ†Ù</span><span class="show-en">Start by adding your first item</span></p>
            </div>
            {% endif %}
            <div style="height:50px"></div>
        </div>
        <div id="tab-shopping" class="page-section">
            <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center">
                <i class="bi bi-cart-check fs-1 me-3 ms-3"></i>
                <div>
                    <h5 class="alert-heading fw-bold m-0"><span class="show-ar">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ÙˆØ§Ù‚Øµ ({{ shopping_list|length }})</span><span class="show-en">Shopping List ({{ shopping_list|length }})</span></h5>
                    <small><span class="show-ar">Ø£ØºØ±Ø§Ø¶ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</span><span class="show-en">Items below minimum quantity</span></small>
                </div>
            </div>
            {% if shopping_list %}
            {% for item in shopping_list %}
            <div class="item-card border border-warning">
                <div class="d-flex justify-content-between align-items-center px-2">
                    <div class="flex-grow-1">
                        <h6 class="mb-0 fw-bold"><span class="show-ar">{{ item.name_ar }}</span><span class="show-en">{{ item.name_en }}</span></h6>
                        <small class="text-danger fw-bold"><span class="show-ar">Ø§Ù„Ù…ØªÙˆÙØ±: {{ item.qty }} (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: {{ item.min }})</span><span class="show-en">In Stock: {{ item.qty }} (Min: {{ item.min }})</span></small>
                    </div>
                    <input type="checkbox" class="form-check-input" style="width:25px;height:25px;">
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state"><i class="bi bi-basket"></i><h5 class="mt-3"><span class="show-ar">âœ… ÙƒÙ„ Ø´ÙŠ Ù…ØªÙˆÙØ±!</span><span class="show-en">âœ… Everything is stocked!</span></h5><p class="text-muted"><span class="show-ar">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØºØ±Ø§Ø¶ ØªØ­ØªØ§Ø¬ Ø´Ø±Ø§Ø¡</span><span class="show-en">No items need restocking</span></p></div>
            {% endif %}
        </div>
    </div>
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('inventory', this)"><i class="bi bi-box-seam"></i><span class="show-ar">Ø§Ù„Ù…Ø®Ø²Ù†</span><span class="show-en">Pantry</span></div>
        <div style="position:relative;width:60px"><button class="fab-btn" data-bs-toggle="modal" data-bs-target="#addItemModal"><i class="bi bi-plus-lg"></i></button></div>
        <div class="nav-item" onclick="switchTab('shopping', this)"><i class="bi bi-cart3"></i><span class="show-ar">Ø§Ù„ØªØ³ÙˆÙ‚</span><span class="show-en">Shop</span></div>
        <div class="nav-item" data-bs-toggle="modal" data-bs-target="#scanModal"><i class="bi bi-camera"></i><span class="show-ar">Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</span><span class="show-en">Scan</span></div>
    </div>
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i><span class="show-ar">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</span><span class="show-en">Add New Item</span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form action="/add" method="POST">
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label fw-bold"><span class="show-ar">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ) *</span><span class="show-en">Name (Arabic) *</span></label><input type="text" name="name_ar" class="form-control" required placeholder="Ù…Ø«Ø§Ù„: Ø­Ù„ÙŠØ¨"></div>
                    <div class="mb-3"><label class="form-label fw-bold"><span class="show-ar">Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) *</span><span class="show-en">Name (English) *</span></label><input type="text" name="name_en" class="form-control" required placeholder="Example: Milk"></div>
                    <div class="row"><div class="col-6 mb-3"><label class="form-label fw-bold"><span class="show-ar">Ø§Ù„ÙƒÙ…ÙŠØ©</span><span class="show-en">Quantity</span></label><input type="number" name="quantity" class="form-control text-center" value="1" min="0"></div>
                    <div class="col-6 mb-3"><label class="form-label fw-bold"><span class="show-ar">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</span><span class="show-en">Min Qty</span></label><input type="number" name="min_quantity" class="form-control text-center" value="2" min="1"></div></div>
                    <div class="mb-3"><label class="form-label fw-bold"><span class="show-ar">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span><span class="show-en">Expiry Date (Optional)</span></label><input type="date" name="expiry_date" class="form-control"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span class="show-ar">Ø¥Ù„ØºØ§Ø¡</span><span class="show-en">Cancel</span></button><button type="submit" class="btn btn-primary px-4"><i class="bi bi-save me-2"></i><span class="show-ar">Ø­ÙØ¸</span><span class="show-en">Save</span></button></div>
            </form>
        </div></div>
    </div>
    <div class="modal fade" id="scanModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="bi bi-upc-scan me-2"></i><span class="show-ar">Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯</span><span class="show-en">Scan Barcode</span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="stopScan()"></button></div>
            <div class="modal-body">
                <div class="ratio ratio-4x3 mb-2" style="border-radius:12px; overflow:hidden; background:#000"><video id="scanVideo" playsinline></video></div>
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-primary" onclick="startScan()"><i class="bi bi-camera-video me-1"></i><span class="show-ar">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­</span><span class="show-en">Start</span></button>
                    <button class="btn btn-outline-secondary" onclick="stopScan()"><i class="bi bi-stop-circle me-1"></i><span class="show-ar">Ø¥ÙŠÙ‚Ø§Ù</span><span class="show-en">Stop</span></button>
                </div>
                <small id="scanStatus" class="text-muted d-block mt-2"></small>
            </div>
        </div></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
    <script>
        function switchTab(tabId, el){document.querySelectorAll('.page-section').forEach(sec=>sec.classList.remove('active'));document.getElementById('tab-'+tabId).classList.add('active');document.querySelectorAll('.nav-item').forEach(nav=>nav.classList.remove('active'));if(el)el.classList.add('active')}
        function toggleLang(){const body=document.body;if(body.classList.contains('lang-ar')){body.classList.remove('lang-ar');body.classList.add('lang-en');localStorage.setItem('appLang','en')}else{body.classList.remove('lang-en');body.classList.add('lang-ar');localStorage.setItem('appLang','ar')}}
        window.onload=function(){const savedLang=localStorage.getItem('appLang');if(savedLang==='en'){document.body.classList.remove('lang-ar');document.body.classList.add('lang-en')}setTimeout(()=>{const alerts=document.querySelectorAll('.flash-alert');alerts.forEach(alert=>{const bsAlert=bootstrap.Alert.getOrCreateInstance(alert);bsAlert.close()})},5000)}
        let codeReader,currentStream;async function startScan(){try{if(!codeReader)codeReader=new ZXing.BrowserMultiFormatReader();const video=document.getElementById('scanVideo');document.getElementById('scanStatus').innerText=document.body.classList.contains('lang-en')?'Opening camera...':'ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';const constraints={video:{facingMode:{ideal:'environment'}}};currentStream=await navigator.mediaDevices.getUserMedia(constraints);video.srcObject=currentStream;await video.play();const controls=await codeReader.decodeFromVideoDevice(null,video,(result,err)=>{if(result&&result.getText){handleScanResult(result.getText())}});window._scanControls=controls}catch(e){document.getElementById('scanStatus').innerText=(document.body.classList.contains('lang-en')?'Camera error: ':'Ø®Ø·Ø£ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ')+(e&&e.message?e.message:e)}}
        function stopScan(){try{if(window._scanControls)window._scanControls.stop()}catch{}try{const video=document.getElementById('scanVideo');if(video)video.pause();if(currentStream)currentStream.getTracks().forEach(t=>t.stop())}catch{}document.getElementById('scanStatus').innerText=''}
        function handleScanResult(text){document.getElementById('scanStatus').innerText=(document.body.classList.contains('lang-en')?'Code: ':'Ø§Ù„ÙƒÙˆØ¯: ')+text;stopScan();fetch('/barcode/lookup?code='+encodeURIComponent(text)).then(r=>r.json()).then(data=>{const nameEnInput=document.querySelector('#addItemModal input[name="name_en"]');const nameArInput=document.querySelector('#addItemModal input[name="name_ar"]');if(nameEnInput&&data.name_en)nameEnInput.value=data.name_en;if(nameArInput&&data.name_ar)nameArInput.value=data.name_ar;const addModalEl=document.getElementById('addItemModal');const addModal=bootstrap.Modal.getOrCreateInstance(addModalEl);addModal.show();const scanModalEl=document.getElementById('scanModal');const scanModal=bootstrap.Modal.getOrCreateInstance(scanModalEl);scanModal.hide()}).catch(()=>{})}
    </script>
</body>
</html>